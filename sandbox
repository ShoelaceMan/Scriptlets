#!/bin/bash
basename="$1"
shift
sandbox="$1"
shift
container="${basename}-${sandbox}"
commandline="$@"
fullcommand=(
  sudo -HnSu $sandbox \
    -i DISPLAY=$DISPLAY \
    -- $commandline
      )
set -m

printf "Container:\t $container\n"
printf "Display:\t $DISPLAY\n"
printf "Running:\t ${fullcommand[@]}\n"

sudo lxc-start -n $container
if sudo lxc-wait --name=$container --state=RUNNING; then
  sudo lxc-attach -n $container -- "${fullcommand[@]}"
  sudo lxc-stop "$container"
else
  printf "Failed to start $container\n"
  sudo lxc-stop "$container"
  exit 1
fi
