#!/usr/sbin/python
# Script to backup selected folders, made for cron
# By Trent Arcuri, 2019
import argparse
import datetime
import distutils.spawn
import os
import socket
import subprocess

if os.geteuid() != 0:
  print('This program requires root access, trying sudo')
  sudoreturnval = subprocess.call("sudo -v", shell=True)
  if sudoreturnval != 0:
    print('Failed to gain root access')
    quit(1)

launchtime = datetime.datetime.now()
rsyncexcludearg = '--exclude='
rsyncoptions = ['-Pauvr', '--delete']
exclude = ["/dev/*",
    "/proc/*",
    "/sys/*",
    "/tmp/*",
    "/run/*",
    "/mnt/*",
    "/media/*",
    "/lost+found"]

parser = argparse.ArgumentParser()
parser.add_argument('-s', '--sleep', type=str, dest='warningseconds',
    default = '10', help='Specify seconds to show warning before continuing')
parser.add_argument('-n', '--name', type=str, dest='backupname',
    default = socket.gethostname(), help='Specify name for this backup')
parser.add_argument('-l', '--log', type=str, dest='backuplog',
    default = '/var/log/backup.log', help='Specify path to log file')
parser.add_argument('-t', '--target', type=str, dest='backuptarget',
    default = '/', help='Specify what to backup')
parser.add_argument('-d', '--directory', type=str, dest='backupdir',
    default = '/mnt/backup/', help='Specify where to backup to')
parser.add_argument('-i', '--increment', dest = 'increment',
    action = 'store_true', default = False, help='Run an incremental backup')
parser.add_argument('-m', '--maxincrement', type = int, dest = 'backupincmax',
    default = 3, help='Run an incremental backup')
args = parser.parse_args()

def banner():
    print("Backup running at", launchtime.strftime("%Y-%m-%d %H:%M:%S"), "\n",
        "Backup target:", args.backuptarget, "\n",
        "Output directory:",args.backupdir, "\n",
        "Backup name:",args.backupname, "\n",
        "Log file:",args.backuplog, "\n",
        "Maximum increments:",args.backupincmax, "\n",
        "Warning timeout:",args.warningseconds, "\n",
        "Increment mode:", args.increment)

def cleanup():
    print('Backup completed, cleaning up')
    subprocess.call(['touch', args.backupdir+args.backupname])
    print(args.backupname, "logging stopped at",datetime.datetime.now())

def incrementprebackup():
    print('Deleting backups older than', args.backupincmax, 'days:')

def rsyncbackup():
    rsyncexclude = [ rsyncexcludearg+excludeitem for excludeitem in exclude ]
    rsynccommand = ['rsync'] + rsyncoptions + rsyncexclude + [args.backuptarget, args.backupdir+args.backupname]
    print("Running", rsynccommand)
    subprocess.call(rsynccommand)

def main():
    banner()    # Print banner, valuable information
    ## Display warning and cancel button ##
    if distutils.spawn.find_executable("xmessage") != None:
        print('Xmessage found, launching warning message')
        warning = subprocess.call(["xmessage", "-timeout", args.warningseconds,
            "-nearmous", "-buttons", "run,cancel",
            "Performing backup in", args.warningseconds, "seconds."])
    if warning == 102:
        print('User cancelled backup.')
        cleanup()
        quit(1)
    ## Display warning and cancel button ##
    print('Running backup')
    if args.increment:
        incrementprebackup
    rsyncbackup()
    cleanup()
main()
